"use strict";var as=Object.create;var Qr=Object.defineProperty;var cs=Object.getOwnPropertyDescriptor;var us=Object.getOwnPropertyNames;var ds=Object.getPrototypeOf,ls=Object.prototype.hasOwnProperty;var C=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var fs=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of us(e))!ls.call(t,i)&&i!==r&&Qr(t,i,{get:()=>e[i],enumerable:!(n=cs(e,i))||n.enumerable});return t};var ps=(t,e,r)=>(r=t!=null?as(ds(t)):{},fs(e||!t||!t.__esModule?Qr(r,"default",{value:t,enumerable:!0}):r,t));var ye=C(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.stringArray=q.array=q.func=q.error=q.number=q.string=q.boolean=void 0;function ms(t){return t===!0||t===!1}q.boolean=ms;function Gr(t){return typeof t=="string"||t instanceof String}q.string=Gr;function hs(t){return typeof t=="number"||t instanceof Number}q.number=hs;function gs(t){return t instanceof Error}q.error=gs;function bs(t){return typeof t=="function"}q.func=bs;function Kr(t){return Array.isArray(t)}q.array=Kr;function ys(t){return Kr(t)&&t.every(e=>Gr(e))}q.stringArray=ys});var Ut=C(l=>{"use strict";Object.defineProperty(l,"__esModule",{value:!0});l.Message=l.NotificationType9=l.NotificationType8=l.NotificationType7=l.NotificationType6=l.NotificationType5=l.NotificationType4=l.NotificationType3=l.NotificationType2=l.NotificationType1=l.NotificationType0=l.NotificationType=l.RequestType9=l.RequestType8=l.RequestType7=l.RequestType6=l.RequestType5=l.RequestType4=l.RequestType3=l.RequestType2=l.RequestType1=l.RequestType=l.RequestType0=l.AbstractMessageSignature=l.ParameterStructures=l.ResponseError=l.ErrorCodes=void 0;var le=ye(),wt;(function(t){t.ParseError=-32700,t.InvalidRequest=-32600,t.MethodNotFound=-32601,t.InvalidParams=-32602,t.InternalError=-32603,t.jsonrpcReservedErrorRangeStart=-32099,t.serverErrorStart=-32099,t.MessageWriteError=-32099,t.MessageReadError=-32098,t.PendingResponseRejected=-32097,t.ConnectionInactive=-32096,t.ServerNotInitialized=-32002,t.UnknownErrorCode=-32001,t.jsonrpcReservedErrorRangeEnd=-32e3,t.serverErrorEnd=-32e3})(wt||(l.ErrorCodes=wt={}));var vt=class t extends Error{constructor(e,r,n){super(r),this.code=le.number(e)?e:wt.UnknownErrorCode,this.data=n,Object.setPrototypeOf(this,t.prototype)}toJson(){let e={code:this.code,message:this.message};return this.data!==void 0&&(e.data=this.data),e}};l.ResponseError=vt;var W=class t{constructor(e){this.kind=e}static is(e){return e===t.auto||e===t.byName||e===t.byPosition}toString(){return this.kind}};l.ParameterStructures=W;W.auto=new W("auto");W.byPosition=new W("byPosition");W.byName=new W("byName");var S=class{constructor(e,r){this.method=e,this.numberOfParams=r}get parameterStructures(){return W.auto}};l.AbstractMessageSignature=S;var kt=class extends S{constructor(e){super(e,0)}};l.RequestType0=kt;var Pt=class extends S{constructor(e,r=W.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.RequestType=Pt;var Rt=class extends S{constructor(e,r=W.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.RequestType1=Rt;var _t=class extends S{constructor(e){super(e,2)}};l.RequestType2=_t;var St=class extends S{constructor(e){super(e,3)}};l.RequestType3=St;var Et=class extends S{constructor(e){super(e,4)}};l.RequestType4=Et;var Tt=class extends S{constructor(e){super(e,5)}};l.RequestType5=Tt;var jt=class extends S{constructor(e){super(e,6)}};l.RequestType6=jt;var xt=class extends S{constructor(e){super(e,7)}};l.RequestType7=xt;var Mt=class extends S{constructor(e){super(e,8)}};l.RequestType8=Mt;var Nt=class extends S{constructor(e){super(e,9)}};l.RequestType9=Nt;var Ot=class extends S{constructor(e,r=W.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.NotificationType=Ot;var Ct=class extends S{constructor(e){super(e,0)}};l.NotificationType0=Ct;var It=class extends S{constructor(e,r=W.auto){super(e,1),this._parameterStructures=r}get parameterStructures(){return this._parameterStructures}};l.NotificationType1=It;var At=class extends S{constructor(e){super(e,2)}};l.NotificationType2=At;var qt=class extends S{constructor(e){super(e,3)}};l.NotificationType3=qt;var Lt=class extends S{constructor(e){super(e,4)}};l.NotificationType4=Lt;var Dt=class extends S{constructor(e){super(e,5)}};l.NotificationType5=Dt;var $t=class extends S{constructor(e){super(e,6)}};l.NotificationType6=$t;var Wt=class extends S{constructor(e){super(e,7)}};l.NotificationType7=Wt;var Bt=class extends S{constructor(e){super(e,8)}};l.NotificationType8=Bt;var Ht=class extends S{constructor(e){super(e,9)}};l.NotificationType9=Ht;var Xr;(function(t){function e(i){let c=i;return c&&le.string(c.method)&&(le.string(c.id)||le.number(c.id))}t.isRequest=e;function r(i){let c=i;return c&&le.string(c.method)&&i.id===void 0}t.isNotification=r;function n(i){let c=i;return c&&(c.result!==void 0||!!c.error)&&(le.string(c.id)||le.number(c.id)||c.id===null)}t.isResponse=n})(Xr||(l.Message=Xr={}))});var Vt=C(oe=>{"use strict";var Zr;Object.defineProperty(oe,"__esModule",{value:!0});oe.LRUCache=oe.LinkedMap=oe.Touch=void 0;var L;(function(t){t.None=0,t.First=1,t.AsOld=t.First,t.Last=2,t.AsNew=t.Last})(L||(oe.Touch=L={}));var Ve=class{constructor(){this[Zr]="LinkedMap",this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){return this._head?.value}get last(){return this._tail?.value}has(e){return this._map.has(e)}get(e,r=L.None){let n=this._map.get(e);if(n)return r!==L.None&&this.touch(n,r),n.value}set(e,r,n=L.None){let i=this._map.get(e);if(i)i.value=r,n!==L.None&&this.touch(i,n);else{switch(i={key:e,value:r,next:void 0,previous:void 0},n){case L.None:this.addItemLast(i);break;case L.First:this.addItemFirst(i);break;case L.Last:this.addItemLast(i);break;default:this.addItemLast(i);break}this._map.set(e,i),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let r=this._map.get(e);if(r)return this._map.delete(e),this.removeItem(r),this._size--,r.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,r){let n=this._state,i=this._head;for(;i;){if(r?e.bind(r)(i.value,i.key,this):e(i.value,i.key,this),this._state!==n)throw new Error("LinkedMap got modified during iteration.");i=i.next}}keys(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:r.key,done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}values(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:r.value,done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}entries(){let e=this._state,r=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(r){let i={value:[r.key,r.value],done:!1};return r=r.next,i}else return{value:void 0,done:!0}}};return n}[(Zr=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let r=this._head,n=this.size;for(;r&&n>e;)this._map.delete(r.key),r=r.next,n--;this._head=r,this._size=n,r&&(r.previous=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let r=e.next,n=e.previous;if(!r||!n)throw new Error("Invalid list");r.previous=n,n.next=r}e.next=void 0,e.previous=void 0,this._state++}touch(e,r){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(r!==L.First&&r!==L.Last)){if(r===L.First){if(e===this._head)return;let n=e.next,i=e.previous;e===this._tail?(i.next=void 0,this._tail=i):(n.previous=i,i.next=n),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(r===L.Last){if(e===this._tail)return;let n=e.next,i=e.previous;e===this._head?(n.previous=void 0,this._head=n):(n.previous=i,i.next=n),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((r,n)=>{e.push([n,r])}),e}fromJSON(e){this.clear();for(let[r,n]of e)this.set(r,n)}};oe.LinkedMap=Ve;var Ft=class extends Ve{constructor(e,r=1){super(),this._limit=e,this._ratio=Math.min(Math.max(0,r),1)}get limit(){return this._limit}set limit(e){this._limit=e,this.checkTrim()}get ratio(){return this._ratio}set ratio(e){this._ratio=Math.min(Math.max(0,e),1),this.checkTrim()}get(e,r=L.AsNew){return super.get(e,r)}peek(e){return super.get(e,L.None)}set(e,r){return super.set(e,r,L.Last),this.checkTrim(),this}checkTrim(){this.size>this._limit&&this.trimOld(Math.round(this._limit*this._ratio))}};oe.LRUCache=Ft});var en=C(Je=>{"use strict";Object.defineProperty(Je,"__esModule",{value:!0});Je.Disposable=void 0;var Yr;(function(t){function e(r){return{dispose:r}}t.create=e})(Yr||(Je.Disposable=Yr={}))});var ae=C(Gt=>{"use strict";Object.defineProperty(Gt,"__esModule",{value:!0});var Jt;function Qt(){if(Jt===void 0)throw new Error("No runtime abstraction layer installed");return Jt}(function(t){function e(r){if(r===void 0)throw new Error("No runtime abstraction layer provided");Jt=r}t.install=e})(Qt||(Qt={}));Gt.default=Qt});var we=C(ze=>{"use strict";Object.defineProperty(ze,"__esModule",{value:!0});ze.Emitter=ze.Event=void 0;var zs=ae(),tn;(function(t){let e={dispose(){}};t.None=function(){return e}})(tn||(ze.Event=tn={}));var Kt=class{add(e,r=null,n){this._callbacks||(this._callbacks=[],this._contexts=[]),this._callbacks.push(e),this._contexts.push(r),Array.isArray(n)&&n.push({dispose:()=>this.remove(e,r)})}remove(e,r=null){if(!this._callbacks)return;let n=!1;for(let i=0,c=this._callbacks.length;i<c;i++)if(this._callbacks[i]===e)if(this._contexts[i]===r){this._callbacks.splice(i,1),this._contexts.splice(i,1);return}else n=!0;if(n)throw new Error("When adding a listener with a context, you should remove it with the same context")}invoke(...e){if(!this._callbacks)return[];let r=[],n=this._callbacks.slice(0),i=this._contexts.slice(0);for(let c=0,p=n.length;c<p;c++)try{r.push(n[c].apply(i[c],e))}catch(g){(0,zs.default)().console.error(g)}return r}isEmpty(){return!this._callbacks||this._callbacks.length===0}dispose(){this._callbacks=void 0,this._contexts=void 0}},Qe=class t{constructor(e){this._options=e}get event(){return this._event||(this._event=(e,r,n)=>{this._callbacks||(this._callbacks=new Kt),this._options&&this._options.onFirstListenerAdd&&this._callbacks.isEmpty()&&this._options.onFirstListenerAdd(this),this._callbacks.add(e,r);let i={dispose:()=>{this._callbacks&&(this._callbacks.remove(e,r),i.dispose=t._noop,this._options&&this._options.onLastListenerRemove&&this._callbacks.isEmpty()&&this._options.onLastListenerRemove(this))}};return Array.isArray(n)&&n.push(i),i}),this._event}fire(e){this._callbacks&&this._callbacks.invoke.call(this._callbacks,e)}dispose(){this._callbacks&&(this._callbacks.dispose(),this._callbacks=void 0)}};ze.Emitter=Qe;Qe._noop=function(){}});var Xe=C(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.CancellationTokenSource=ve.CancellationToken=void 0;var ws=ae(),vs=ye(),Xt=we(),Ge;(function(t){t.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:Xt.Event.None}),t.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:Xt.Event.None});function e(r){let n=r;return n&&(n===t.None||n===t.Cancelled||vs.boolean(n.isCancellationRequested)&&!!n.onCancellationRequested)}t.is=e})(Ge||(ve.CancellationToken=Ge={}));var ks=Object.freeze(function(t,e){let r=(0,ws.default)().timer.setTimeout(t.bind(e),0);return{dispose(){r.dispose()}}}),Ke=class{constructor(){this._isCancelled=!1}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?ks:(this._emitter||(this._emitter=new Xt.Emitter),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}},Zt=class{get token(){return this._token||(this._token=new Ke),this._token}cancel(){this._token?this._token.cancel():this._token=Ge.Cancelled}dispose(){this._token?this._token instanceof Ke&&this._token.dispose():this._token=Ge.None}};ve.CancellationTokenSource=Zt});var rn=C(ke=>{"use strict";Object.defineProperty(ke,"__esModule",{value:!0});ke.SharedArrayReceiverStrategy=ke.SharedArraySenderStrategy=void 0;var Ps=Xe(),Ce;(function(t){t.Continue=0,t.Cancelled=1})(Ce||(Ce={}));var Yt=class{constructor(){this.buffers=new Map}enableCancellation(e){if(e.id===null)return;let r=new SharedArrayBuffer(4),n=new Int32Array(r,0,1);n[0]=Ce.Continue,this.buffers.set(e.id,r),e.$cancellationData=r}async sendCancellation(e,r){let n=this.buffers.get(r);if(n===void 0)return;let i=new Int32Array(n,0,1);Atomics.store(i,0,Ce.Cancelled)}cleanup(e){this.buffers.delete(e)}dispose(){this.buffers.clear()}};ke.SharedArraySenderStrategy=Yt;var er=class{constructor(e){this.data=new Int32Array(e,0,1)}get isCancellationRequested(){return Atomics.load(this.data,0)===Ce.Cancelled}get onCancellationRequested(){throw new Error("Cancellation over SharedArrayBuffer doesn't support cancellation events")}},tr=class{constructor(e){this.token=new er(e)}cancel(){}dispose(){}},rr=class{constructor(){this.kind="request"}createCancellationTokenSource(e){let r=e.$cancellationData;return r===void 0?new Ps.CancellationTokenSource:new tr(r)}};ke.SharedArrayReceiverStrategy=rr});var sr=C(Ze=>{"use strict";Object.defineProperty(Ze,"__esModule",{value:!0});Ze.Semaphore=void 0;var Rs=ae(),nr=class{constructor(e=1){if(e<=0)throw new Error("Capacity must be greater than 0");this._capacity=e,this._active=0,this._waiting=[]}lock(e){return new Promise((r,n)=>{this._waiting.push({thunk:e,resolve:r,reject:n}),this.runNext()})}get active(){return this._active}runNext(){this._waiting.length===0||this._active===this._capacity||(0,Rs.default)().timer.setImmediate(()=>this.doRunNext())}doRunNext(){if(this._waiting.length===0||this._active===this._capacity)return;let e=this._waiting.shift();if(this._active++,this._active>this._capacity)throw new Error("To many thunks active");try{let r=e.thunk();r instanceof Promise?r.then(n=>{this._active--,e.resolve(n),this.runNext()},n=>{this._active--,e.reject(n),this.runNext()}):(this._active--,e.resolve(r),this.runNext())}catch(r){this._active--,e.reject(r),this.runNext()}}};Ze.Semaphore=nr});var sn=C(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.ReadableStreamMessageReader=ce.AbstractMessageReader=ce.MessageReader=void 0;var or=ae(),Pe=ye(),ir=we(),_s=sr(),nn;(function(t){function e(r){let n=r;return n&&Pe.func(n.listen)&&Pe.func(n.dispose)&&Pe.func(n.onError)&&Pe.func(n.onClose)&&Pe.func(n.onPartialMessage)}t.is=e})(nn||(ce.MessageReader=nn={}));var Ye=class{constructor(){this.errorEmitter=new ir.Emitter,this.closeEmitter=new ir.Emitter,this.partialMessageEmitter=new ir.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e){this.errorEmitter.fire(this.asError(e))}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}get onPartialMessage(){return this.partialMessageEmitter.event}firePartialMessage(e){this.partialMessageEmitter.fire(e)}asError(e){return e instanceof Error?e:new Error(`Reader received error. Reason: ${Pe.string(e.message)?e.message:"unknown"}`)}};ce.AbstractMessageReader=Ye;var ar;(function(t){function e(r){let n,i,c,p=new Map,g,P=new Map;if(r===void 0||typeof r=="string")n=r??"utf-8";else{if(n=r.charset??"utf-8",r.contentDecoder!==void 0&&(c=r.contentDecoder,p.set(c.name,c)),r.contentDecoders!==void 0)for(let R of r.contentDecoders)p.set(R.name,R);if(r.contentTypeDecoder!==void 0&&(g=r.contentTypeDecoder,P.set(g.name,g)),r.contentTypeDecoders!==void 0)for(let R of r.contentTypeDecoders)P.set(R.name,R)}return g===void 0&&(g=(0,or.default)().applicationJson.decoder,P.set(g.name,g)),{charset:n,contentDecoder:c,contentDecoders:p,contentTypeDecoder:g,contentTypeDecoders:P}}t.fromOptions=e})(ar||(ar={}));var cr=class extends Ye{constructor(e,r){super(),this.readable=e,this.options=ar.fromOptions(r),this.buffer=(0,or.default)().messageBuffer.create(this.options.charset),this._partialMessageTimeout=1e4,this.nextMessageLength=-1,this.messageToken=0,this.readSemaphore=new _s.Semaphore(1)}set partialMessageTimeout(e){this._partialMessageTimeout=e}get partialMessageTimeout(){return this._partialMessageTimeout}listen(e){this.nextMessageLength=-1,this.messageToken=0,this.partialMessageTimer=void 0,this.callback=e;let r=this.readable.onData(n=>{this.onData(n)});return this.readable.onError(n=>this.fireError(n)),this.readable.onClose(()=>this.fireClose()),r}onData(e){try{for(this.buffer.append(e);;){if(this.nextMessageLength===-1){let n=this.buffer.tryReadHeaders(!0);if(!n)return;let i=n.get("content-length");if(!i){this.fireError(new Error(`Header must provide a Content-Length property.
${JSON.stringify(Object.fromEntries(n))}`));return}let c=parseInt(i);if(isNaN(c)){this.fireError(new Error(`Content-Length value must be a number. Got ${i}`));return}this.nextMessageLength=c}let r=this.buffer.tryReadBody(this.nextMessageLength);if(r===void 0){this.setPartialMessageTimer();return}this.clearPartialMessageTimer(),this.nextMessageLength=-1,this.readSemaphore.lock(async()=>{let n=this.options.contentDecoder!==void 0?await this.options.contentDecoder.decode(r):r,i=await this.options.contentTypeDecoder.decode(n,this.options);this.callback(i)}).catch(n=>{this.fireError(n)})}}catch(r){this.fireError(r)}}clearPartialMessageTimer(){this.partialMessageTimer&&(this.partialMessageTimer.dispose(),this.partialMessageTimer=void 0)}setPartialMessageTimer(){this.clearPartialMessageTimer(),!(this._partialMessageTimeout<=0)&&(this.partialMessageTimer=(0,or.default)().timer.setTimeout((e,r)=>{this.partialMessageTimer=void 0,e===this.messageToken&&(this.firePartialMessage({messageToken:e,waitingTime:r}),this.setPartialMessageTimer())},this._partialMessageTimeout,this.messageToken,this._partialMessageTimeout))}};ce.ReadableStreamMessageReader=cr});var dn=C(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.WriteableStreamMessageWriter=ue.AbstractMessageWriter=ue.MessageWriter=void 0;var on=ae(),Ie=ye(),Ss=sr(),an=we(),Es="Content-Length: ",cn=`\r
`,un;(function(t){function e(r){let n=r;return n&&Ie.func(n.dispose)&&Ie.func(n.onClose)&&Ie.func(n.onError)&&Ie.func(n.write)}t.is=e})(un||(ue.MessageWriter=un={}));var et=class{constructor(){this.errorEmitter=new an.Emitter,this.closeEmitter=new an.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e,r,n){this.errorEmitter.fire([this.asError(e),r,n])}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}asError(e){return e instanceof Error?e:new Error(`Writer received error. Reason: ${Ie.string(e.message)?e.message:"unknown"}`)}};ue.AbstractMessageWriter=et;var ur;(function(t){function e(r){return r===void 0||typeof r=="string"?{charset:r??"utf-8",contentTypeEncoder:(0,on.default)().applicationJson.encoder}:{charset:r.charset??"utf-8",contentEncoder:r.contentEncoder,contentTypeEncoder:r.contentTypeEncoder??(0,on.default)().applicationJson.encoder}}t.fromOptions=e})(ur||(ur={}));var dr=class extends et{constructor(e,r){super(),this.writable=e,this.options=ur.fromOptions(r),this.errorCount=0,this.writeSemaphore=new Ss.Semaphore(1),this.writable.onError(n=>this.fireError(n)),this.writable.onClose(()=>this.fireClose())}async write(e){return this.writeSemaphore.lock(async()=>this.options.contentTypeEncoder.encode(e,this.options).then(n=>this.options.contentEncoder!==void 0?this.options.contentEncoder.encode(n):n).then(n=>{let i=[];return i.push(Es,n.byteLength.toString(),cn),i.push(cn),this.doWrite(e,i,n)},n=>{throw this.fireError(n),n}))}async doWrite(e,r,n){try{return await this.writable.write(r.join(""),"ascii"),this.writable.write(n)}catch(i){return this.handleError(i,e),Promise.reject(i)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){this.writable.end()}};ue.WriteableStreamMessageWriter=dr});var ln=C(tt=>{"use strict";Object.defineProperty(tt,"__esModule",{value:!0});tt.AbstractMessageBuffer=void 0;var Ts=13,js=10,xs=`\r
`,lr=class{constructor(e="utf-8"){this._encoding=e,this._chunks=[],this._totalLength=0}get encoding(){return this._encoding}append(e){let r=typeof e=="string"?this.fromString(e,this._encoding):e;this._chunks.push(r),this._totalLength+=r.byteLength}tryReadHeaders(e=!1){if(this._chunks.length===0)return;let r=0,n=0,i=0,c=0;e:for(;n<this._chunks.length;){let R=this._chunks[n];for(i=0;i<R.length;){switch(R[i]){case Ts:switch(r){case 0:r=1;break;case 2:r=3;break;default:r=0}break;case js:switch(r){case 1:r=2;break;case 3:r=4,i++;break e;default:r=0}break;default:r=0}i++}c+=R.byteLength,n++}if(r!==4)return;let p=this._read(c+i),g=new Map,P=this.toString(p,"ascii").split(xs);if(P.length<2)return g;for(let R=0;R<P.length-2;R++){let A=P[R],$=A.indexOf(":");if($===-1)throw new Error(`Message header must separate key and value using ':'
${A}`);let F=A.substr(0,$),V=A.substr($+1).trim();g.set(e?F.toLowerCase():F,V)}return g}tryReadBody(e){if(!(this._totalLength<e))return this._read(e)}get numberOfBytes(){return this._totalLength}_read(e){if(e===0)return this.emptyBuffer();if(e>this._totalLength)throw new Error("Cannot read so many bytes!");if(this._chunks[0].byteLength===e){let c=this._chunks[0];return this._chunks.shift(),this._totalLength-=e,this.asNative(c)}if(this._chunks[0].byteLength>e){let c=this._chunks[0],p=this.asNative(c,e);return this._chunks[0]=c.slice(e),this._totalLength-=e,p}let r=this.allocNative(e),n=0,i=0;for(;e>0;){let c=this._chunks[i];if(c.byteLength>e){let p=c.slice(0,e);r.set(p,n),n+=e,this._chunks[i]=c.slice(e),this._totalLength-=e,e-=e}else r.set(c,n),n+=c.byteLength,this._chunks.shift(),this._totalLength-=c.byteLength,e-=c.byteLength}return r}};tt.AbstractMessageBuffer=lr});var gn=C(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.createMessageConnection=m.ConnectionOptions=m.MessageStrategy=m.CancellationStrategy=m.CancellationSenderStrategy=m.CancellationReceiverStrategy=m.RequestCancellationReceiverStrategy=m.IdCancellationReceiverStrategy=m.ConnectionStrategy=m.ConnectionError=m.ConnectionErrors=m.LogTraceNotification=m.SetTraceNotification=m.TraceFormat=m.TraceValues=m.Trace=m.NullLogger=m.ProgressType=m.ProgressToken=void 0;var fn=ae(),j=ye(),f=Ut(),pn=Vt(),Ae=we(),fr=Xe(),De;(function(t){t.type=new f.NotificationType("$/cancelRequest")})(De||(De={}));var pr;(function(t){function e(r){return typeof r=="string"||typeof r=="number"}t.is=e})(pr||(m.ProgressToken=pr={}));var qe;(function(t){t.type=new f.NotificationType("$/progress")})(qe||(qe={}));var mr=class{constructor(){}};m.ProgressType=mr;var hr;(function(t){function e(r){return j.func(r)}t.is=e})(hr||(hr={}));m.NullLogger=Object.freeze({error:()=>{},warn:()=>{},info:()=>{},log:()=>{}});var y;(function(t){t[t.Off=0]="Off",t[t.Messages=1]="Messages",t[t.Compact=2]="Compact",t[t.Verbose=3]="Verbose"})(y||(m.Trace=y={}));var mn;(function(t){t.Off="off",t.Messages="messages",t.Compact="compact",t.Verbose="verbose"})(mn||(m.TraceValues=mn={}));(function(t){function e(n){if(!j.string(n))return t.Off;switch(n=n.toLowerCase(),n){case"off":return t.Off;case"messages":return t.Messages;case"compact":return t.Compact;case"verbose":return t.Verbose;default:return t.Off}}t.fromString=e;function r(n){switch(n){case t.Off:return"off";case t.Messages:return"messages";case t.Compact:return"compact";case t.Verbose:return"verbose";default:return"off"}}t.toString=r})(y||(m.Trace=y={}));var H;(function(t){t.Text="text",t.JSON="json"})(H||(m.TraceFormat=H={}));(function(t){function e(r){return j.string(r)?(r=r.toLowerCase(),r==="json"?t.JSON:t.Text):t.Text}t.fromString=e})(H||(m.TraceFormat=H={}));var gr;(function(t){t.type=new f.NotificationType("$/setTrace")})(gr||(m.SetTraceNotification=gr={}));var rt;(function(t){t.type=new f.NotificationType("$/logTrace")})(rt||(m.LogTraceNotification=rt={}));var Le;(function(t){t[t.Closed=1]="Closed",t[t.Disposed=2]="Disposed",t[t.AlreadyListening=3]="AlreadyListening"})(Le||(m.ConnectionErrors=Le={}));var Re=class t extends Error{constructor(e,r){super(r),this.code=e,Object.setPrototypeOf(this,t.prototype)}};m.ConnectionError=Re;var br;(function(t){function e(r){let n=r;return n&&j.func(n.cancelUndispatched)}t.is=e})(br||(m.ConnectionStrategy=br={}));var nt;(function(t){function e(r){let n=r;return n&&(n.kind===void 0||n.kind==="id")&&j.func(n.createCancellationTokenSource)&&(n.dispose===void 0||j.func(n.dispose))}t.is=e})(nt||(m.IdCancellationReceiverStrategy=nt={}));var yr;(function(t){function e(r){let n=r;return n&&n.kind==="request"&&j.func(n.createCancellationTokenSource)&&(n.dispose===void 0||j.func(n.dispose))}t.is=e})(yr||(m.RequestCancellationReceiverStrategy=yr={}));var st;(function(t){t.Message=Object.freeze({createCancellationTokenSource(r){return new fr.CancellationTokenSource}});function e(r){return nt.is(r)||yr.is(r)}t.is=e})(st||(m.CancellationReceiverStrategy=st={}));var it;(function(t){t.Message=Object.freeze({sendCancellation(r,n){return r.sendNotification(De.type,{id:n})},cleanup(r){}});function e(r){let n=r;return n&&j.func(n.sendCancellation)&&j.func(n.cleanup)}t.is=e})(it||(m.CancellationSenderStrategy=it={}));var ot;(function(t){t.Message=Object.freeze({receiver:st.Message,sender:it.Message});function e(r){let n=r;return n&&st.is(n.receiver)&&it.is(n.sender)}t.is=e})(ot||(m.CancellationStrategy=ot={}));var at;(function(t){function e(r){let n=r;return n&&j.func(n.handleMessage)}t.is=e})(at||(m.MessageStrategy=at={}));var hn;(function(t){function e(r){let n=r;return n&&(ot.is(n.cancellationStrategy)||br.is(n.connectionStrategy)||at.is(n.messageStrategy))}t.is=e})(hn||(m.ConnectionOptions=hn={}));var X;(function(t){t[t.New=1]="New",t[t.Listening=2]="Listening",t[t.Closed=3]="Closed",t[t.Disposed=4]="Disposed"})(X||(X={}));function Ms(t,e,r,n){let i=r!==void 0?r:m.NullLogger,c=0,p=0,g=0,P="2.0",R,A=new Map,$,F=new Map,V=new Map,re,J=new pn.LinkedMap,Q=new Map,ne=new Set,B=new Map,z=y.Off,K=H.Text,E,G=X.New,de=new Ae.Emitter,Me=new Ae.Emitter,He=new Ae.Emitter,Ue=new Ae.Emitter,bt=new Ae.Emitter,se=n&&n.cancellationStrategy?n.cancellationStrategy:ot.Message;function Dr(s){if(s===null)throw new Error("Can't send requests with id null since the response can't be correlated.");return"req-"+s.toString()}function Bn(s){return s===null?"res-unknown-"+(++g).toString():"res-"+s.toString()}function Hn(){return"not-"+(++p).toString()}function Un(s,a){f.Message.isRequest(a)?s.set(Dr(a.id),a):f.Message.isResponse(a)?s.set(Bn(a.id),a):s.set(Hn(),a)}function Fn(s){}function $r(){return G===X.Listening}function Wr(){return G===X.Closed}function he(){return G===X.Disposed}function Br(){(G===X.New||G===X.Listening)&&(G=X.Closed,Me.fire(void 0))}function Vn(s){de.fire([s,void 0,void 0])}function Jn(s){de.fire(s)}t.onClose(Br),t.onError(Vn),e.onClose(Br),e.onError(Jn);function Hr(){re||J.size===0||(re=(0,fn.default)().timer.setImmediate(()=>{re=void 0,Qn()}))}function Ur(s){f.Message.isRequest(s)?Kn(s):f.Message.isNotification(s)?Zn(s):f.Message.isResponse(s)?Xn(s):Yn(s)}function Qn(){if(J.size===0)return;let s=J.shift();try{let a=n?.messageStrategy;at.is(a)?a.handleMessage(s,Ur):Ur(s)}finally{Hr()}}let Gn=s=>{try{if(f.Message.isNotification(s)&&s.method===De.type.method){let a=s.params.id,u=Dr(a),d=J.get(u);if(f.Message.isRequest(d)){let v=n?.connectionStrategy,x=v&&v.cancelUndispatched?v.cancelUndispatched(d,Fn):void 0;if(x&&(x.error!==void 0||x.result!==void 0)){J.delete(u),B.delete(a),x.id=d.id,Fe(x,s.method,Date.now()),e.write(x).catch(()=>i.error("Sending response for canceled message failed."));return}}let _=B.get(a);if(_!==void 0){_.cancel(),yt(s);return}else ne.add(a)}Un(J,s)}finally{Hr()}};function Kn(s){if(he())return;function a(b,T,w){let O={jsonrpc:P,id:s.id};b instanceof f.ResponseError?O.error=b.toJson():O.result=b===void 0?null:b,Fe(O,T,w),e.write(O).catch(()=>i.error("Sending response failed."))}function u(b,T,w){let O={jsonrpc:P,id:s.id,error:b.toJson()};Fe(O,T,w),e.write(O).catch(()=>i.error("Sending response failed."))}function d(b,T,w){b===void 0&&(b=null);let O={jsonrpc:P,id:s.id,result:b};Fe(O,T,w),e.write(O).catch(()=>i.error("Sending response failed."))}rs(s);let _=A.get(s.method),v,x;_&&(v=_.type,x=_.handler);let M=Date.now();if(x||R){let b=s.id??String(Date.now()),T=nt.is(se.receiver)?se.receiver.createCancellationTokenSource(b):se.receiver.createCancellationTokenSource(s);s.id!==null&&ne.has(s.id)&&T.cancel(),s.id!==null&&B.set(b,T);try{let w;if(x)if(s.params===void 0){if(v!==void 0&&v.numberOfParams!==0){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines ${v.numberOfParams} params but received none.`),s.method,M);return}w=x(T.token)}else if(Array.isArray(s.params)){if(v!==void 0&&v.parameterStructures===f.ParameterStructures.byName){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines parameters by name but received parameters by position`),s.method,M);return}w=x(...s.params,T.token)}else{if(v!==void 0&&v.parameterStructures===f.ParameterStructures.byPosition){u(new f.ResponseError(f.ErrorCodes.InvalidParams,`Request ${s.method} defines parameters by position but received parameters by name`),s.method,M);return}w=x(s.params,T.token)}else R&&(w=R(s.method,s.params,T.token));let O=w;w?O.then?O.then(D=>{B.delete(b),a(D,s.method,M)},D=>{B.delete(b),D instanceof f.ResponseError?u(D,s.method,M):D&&j.string(D.message)?u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed with message: ${D.message}`),s.method,M):u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed unexpectedly without providing any details.`),s.method,M)}):(B.delete(b),a(w,s.method,M)):(B.delete(b),d(w,s.method,M))}catch(w){B.delete(b),w instanceof f.ResponseError?a(w,s.method,M):w&&j.string(w.message)?u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed with message: ${w.message}`),s.method,M):u(new f.ResponseError(f.ErrorCodes.InternalError,`Request ${s.method} failed unexpectedly without providing any details.`),s.method,M)}}else u(new f.ResponseError(f.ErrorCodes.MethodNotFound,`Unhandled method ${s.method}`),s.method,M)}function Xn(s){if(!he())if(s.id===null)s.error?i.error(`Received response message without id: Error is: 
${JSON.stringify(s.error,void 0,4)}`):i.error("Received response message without id. No further error information provided.");else{let a=s.id,u=Q.get(a);if(ns(s,u),u!==void 0){Q.delete(a);try{if(s.error){let d=s.error;u.reject(new f.ResponseError(d.code,d.message,d.data))}else if(s.result!==void 0)u.resolve(s.result);else throw new Error("Should never happen.")}catch(d){d.message?i.error(`Response handler '${u.method}' failed with message: ${d.message}`):i.error(`Response handler '${u.method}' failed unexpectedly.`)}}}}function Zn(s){if(he())return;let a,u;if(s.method===De.type.method){let d=s.params.id;ne.delete(d),yt(s);return}else{let d=F.get(s.method);d&&(u=d.handler,a=d.type)}if(u||$)try{if(yt(s),u)if(s.params===void 0)a!==void 0&&a.numberOfParams!==0&&a.parameterStructures!==f.ParameterStructures.byName&&i.error(`Notification ${s.method} defines ${a.numberOfParams} params but received none.`),u();else if(Array.isArray(s.params)){let d=s.params;s.method===qe.type.method&&d.length===2&&pr.is(d[0])?u({token:d[0],value:d[1]}):(a!==void 0&&(a.parameterStructures===f.ParameterStructures.byName&&i.error(`Notification ${s.method} defines parameters by name but received parameters by position`),a.numberOfParams!==s.params.length&&i.error(`Notification ${s.method} defines ${a.numberOfParams} params but received ${d.length} arguments`)),u(...d))}else a!==void 0&&a.parameterStructures===f.ParameterStructures.byPosition&&i.error(`Notification ${s.method} defines parameters by position but received parameters by name`),u(s.params);else $&&$(s.method,s.params)}catch(d){d.message?i.error(`Notification handler '${s.method}' failed with message: ${d.message}`):i.error(`Notification handler '${s.method}' failed unexpectedly.`)}else He.fire(s)}function Yn(s){if(!s){i.error("Received empty message.");return}i.error(`Received message which is neither a response nor a notification message:
${JSON.stringify(s,null,4)}`);let a=s;if(j.string(a.id)||j.number(a.id)){let u=a.id,d=Q.get(u);d&&d.reject(new Error("The received response has neither a result nor an error property."))}}function ie(s){if(s!=null)switch(z){case y.Verbose:return JSON.stringify(s,null,4);case y.Compact:return JSON.stringify(s);default:return}}function es(s){if(!(z===y.Off||!E))if(K===H.Text){let a;(z===y.Verbose||z===y.Compact)&&s.params&&(a=`Params: ${ie(s.params)}

`),E.log(`Sending request '${s.method} - (${s.id})'.`,a)}else ge("send-request",s)}function ts(s){if(!(z===y.Off||!E))if(K===H.Text){let a;(z===y.Verbose||z===y.Compact)&&(s.params?a=`Params: ${ie(s.params)}

`:a=`No parameters provided.

`),E.log(`Sending notification '${s.method}'.`,a)}else ge("send-notification",s)}function Fe(s,a,u){if(!(z===y.Off||!E))if(K===H.Text){let d;(z===y.Verbose||z===y.Compact)&&(s.error&&s.error.data?d=`Error data: ${ie(s.error.data)}

`:s.result?d=`Result: ${ie(s.result)}

`:s.error===void 0&&(d=`No result returned.

`)),E.log(`Sending response '${a} - (${s.id})'. Processing request took ${Date.now()-u}ms`,d)}else ge("send-response",s)}function rs(s){if(!(z===y.Off||!E))if(K===H.Text){let a;(z===y.Verbose||z===y.Compact)&&s.params&&(a=`Params: ${ie(s.params)}

`),E.log(`Received request '${s.method} - (${s.id})'.`,a)}else ge("receive-request",s)}function yt(s){if(!(z===y.Off||!E||s.method===rt.type.method))if(K===H.Text){let a;(z===y.Verbose||z===y.Compact)&&(s.params?a=`Params: ${ie(s.params)}

`:a=`No parameters provided.

`),E.log(`Received notification '${s.method}'.`,a)}else ge("receive-notification",s)}function ns(s,a){if(!(z===y.Off||!E))if(K===H.Text){let u;if((z===y.Verbose||z===y.Compact)&&(s.error&&s.error.data?u=`Error data: ${ie(s.error.data)}

`:s.result?u=`Result: ${ie(s.result)}

`:s.error===void 0&&(u=`No result returned.

`)),a){let d=s.error?` Request failed: ${s.error.message} (${s.error.code}).`:"";E.log(`Received response '${a.method} - (${s.id})' in ${Date.now()-a.timerStart}ms.${d}`,u)}else E.log(`Received response ${s.id} without active response promise.`,u)}else ge("receive-response",s)}function ge(s,a){if(!E||z===y.Off)return;let u={isLSPMessage:!0,type:s,message:a,timestamp:Date.now()};E.log(u)}function Ne(){if(Wr())throw new Re(Le.Closed,"Connection is closed.");if(he())throw new Re(Le.Disposed,"Connection is disposed.")}function ss(){if($r())throw new Re(Le.AlreadyListening,"Connection is already listening")}function is(){if(!$r())throw new Error("Call listen() first.")}function Oe(s){return s===void 0?null:s}function Fr(s){if(s!==null)return s}function Vr(s){return s!=null&&!Array.isArray(s)&&typeof s=="object"}function zt(s,a){switch(s){case f.ParameterStructures.auto:return Vr(a)?Fr(a):[Oe(a)];case f.ParameterStructures.byName:if(!Vr(a))throw new Error("Received parameters by name but param is not an object literal.");return Fr(a);case f.ParameterStructures.byPosition:return[Oe(a)];default:throw new Error(`Unknown parameter structure ${s.toString()}`)}}function Jr(s,a){let u,d=s.numberOfParams;switch(d){case 0:u=void 0;break;case 1:u=zt(s.parameterStructures,a[0]);break;default:u=[];for(let _=0;_<a.length&&_<d;_++)u.push(Oe(a[_]));if(a.length<d)for(let _=a.length;_<d;_++)u.push(null);break}return u}let be={sendNotification:(s,...a)=>{Ne();let u,d;if(j.string(s)){u=s;let v=a[0],x=0,M=f.ParameterStructures.auto;f.ParameterStructures.is(v)&&(x=1,M=v);let b=a.length,T=b-x;switch(T){case 0:d=void 0;break;case 1:d=zt(M,a[x]);break;default:if(M===f.ParameterStructures.byName)throw new Error(`Received ${T} parameters for 'by Name' notification parameter structure.`);d=a.slice(x,b).map(w=>Oe(w));break}}else{let v=a;u=s.method,d=Jr(s,v)}let _={jsonrpc:P,method:u,params:d};return ts(_),e.write(_).catch(v=>{throw i.error("Sending notification failed."),v})},onNotification:(s,a)=>{Ne();let u;return j.func(s)?$=s:a&&(j.string(s)?(u=s,F.set(s,{type:void 0,handler:a})):(u=s.method,F.set(s.method,{type:s,handler:a}))),{dispose:()=>{u!==void 0?F.delete(u):$=void 0}}},onProgress:(s,a,u)=>{if(V.has(a))throw new Error(`Progress handler for token ${a} already registered`);return V.set(a,u),{dispose:()=>{V.delete(a)}}},sendProgress:(s,a,u)=>be.sendNotification(qe.type,{token:a,value:u}),onUnhandledProgress:Ue.event,sendRequest:(s,...a)=>{Ne(),is();let u,d,_;if(j.string(s)){u=s;let b=a[0],T=a[a.length-1],w=0,O=f.ParameterStructures.auto;f.ParameterStructures.is(b)&&(w=1,O=b);let D=a.length;fr.CancellationToken.is(T)&&(D=D-1,_=T);let Y=D-w;switch(Y){case 0:d=void 0;break;case 1:d=zt(O,a[w]);break;default:if(O===f.ParameterStructures.byName)throw new Error(`Received ${Y} parameters for 'by Name' request parameter structure.`);d=a.slice(w,D).map(os=>Oe(os));break}}else{let b=a;u=s.method,d=Jr(s,b);let T=s.numberOfParams;_=fr.CancellationToken.is(b[T])?b[T]:void 0}let v=c++,x;_&&(x=_.onCancellationRequested(()=>{let b=se.sender.sendCancellation(be,v);return b===void 0?(i.log(`Received no promise from cancellation strategy when cancelling id ${v}`),Promise.resolve()):b.catch(()=>{i.log(`Sending cancellation messages for id ${v} failed`)})}));let M={jsonrpc:P,id:v,method:u,params:d};return es(M),typeof se.sender.enableCancellation=="function"&&se.sender.enableCancellation(M),new Promise(async(b,T)=>{let w=Y=>{b(Y),se.sender.cleanup(v),x?.dispose()},O=Y=>{T(Y),se.sender.cleanup(v),x?.dispose()},D={method:u,timerStart:Date.now(),resolve:w,reject:O};try{Q.set(v,D),await e.write(M)}catch(Y){throw Q.delete(v),D.reject(new f.ResponseError(f.ErrorCodes.MessageWriteError,Y.message?Y.message:"Unknown reason")),i.error("Sending request failed."),Y}})},onRequest:(s,a)=>{Ne();let u=null;return hr.is(s)?(u=void 0,R=s):j.string(s)?(u=null,a!==void 0&&(u=s,A.set(s,{handler:a,type:void 0}))):a!==void 0&&(u=s.method,A.set(s.method,{type:s,handler:a})),{dispose:()=>{u!==null&&(u!==void 0?A.delete(u):R=void 0)}}},hasPendingResponse:()=>Q.size>0,trace:async(s,a,u)=>{let d=!1,_=H.Text;u!==void 0&&(j.boolean(u)?d=u:(d=u.sendNotification||!1,_=u.traceFormat||H.Text)),z=s,K=_,z===y.Off?E=void 0:E=a,d&&!Wr()&&!he()&&await be.sendNotification(gr.type,{value:y.toString(s)})},onError:de.event,onClose:Me.event,onUnhandledNotification:He.event,onDispose:bt.event,end:()=>{e.end()},dispose:()=>{if(he())return;G=X.Disposed,bt.fire(void 0);let s=new f.ResponseError(f.ErrorCodes.PendingResponseRejected,"Pending response rejected since connection got disposed");for(let a of Q.values())a.reject(s);Q=new Map,B=new Map,ne=new Set,J=new pn.LinkedMap,j.func(e.dispose)&&e.dispose(),j.func(t.dispose)&&t.dispose()},listen:()=>{Ne(),ss(),G=X.Listening,t.listen(Gn)},inspect:()=>{(0,fn.default)().console.log("inspect")}};return be.onNotification(rt.type,s=>{if(z===y.Off||!E)return;let a=z===y.Verbose||z===y.Compact;E.log(s.message,a?s.verbose:void 0)}),be.onNotification(qe.type,s=>{let a=V.get(s.token);a?a(s.value):Ue.fire(s)}),be}m.createMessageConnection=Ms});var ct=C(o=>{"use strict";Object.defineProperty(o,"__esModule",{value:!0});o.ProgressType=o.ProgressToken=o.createMessageConnection=o.NullLogger=o.ConnectionOptions=o.ConnectionStrategy=o.AbstractMessageBuffer=o.WriteableStreamMessageWriter=o.AbstractMessageWriter=o.MessageWriter=o.ReadableStreamMessageReader=o.AbstractMessageReader=o.MessageReader=o.SharedArrayReceiverStrategy=o.SharedArraySenderStrategy=o.CancellationToken=o.CancellationTokenSource=o.Emitter=o.Event=o.Disposable=o.LRUCache=o.Touch=o.LinkedMap=o.ParameterStructures=o.NotificationType9=o.NotificationType8=o.NotificationType7=o.NotificationType6=o.NotificationType5=o.NotificationType4=o.NotificationType3=o.NotificationType2=o.NotificationType1=o.NotificationType0=o.NotificationType=o.ErrorCodes=o.ResponseError=o.RequestType9=o.RequestType8=o.RequestType7=o.RequestType6=o.RequestType5=o.RequestType4=o.RequestType3=o.RequestType2=o.RequestType1=o.RequestType0=o.RequestType=o.Message=o.RAL=void 0;o.MessageStrategy=o.CancellationStrategy=o.CancellationSenderStrategy=o.CancellationReceiverStrategy=o.ConnectionError=o.ConnectionErrors=o.LogTraceNotification=o.SetTraceNotification=o.TraceFormat=o.TraceValues=o.Trace=void 0;var k=Ut();Object.defineProperty(o,"Message",{enumerable:!0,get:function(){return k.Message}});Object.defineProperty(o,"RequestType",{enumerable:!0,get:function(){return k.RequestType}});Object.defineProperty(o,"RequestType0",{enumerable:!0,get:function(){return k.RequestType0}});Object.defineProperty(o,"RequestType1",{enumerable:!0,get:function(){return k.RequestType1}});Object.defineProperty(o,"RequestType2",{enumerable:!0,get:function(){return k.RequestType2}});Object.defineProperty(o,"RequestType3",{enumerable:!0,get:function(){return k.RequestType3}});Object.defineProperty(o,"RequestType4",{enumerable:!0,get:function(){return k.RequestType4}});Object.defineProperty(o,"RequestType5",{enumerable:!0,get:function(){return k.RequestType5}});Object.defineProperty(o,"RequestType6",{enumerable:!0,get:function(){return k.RequestType6}});Object.defineProperty(o,"RequestType7",{enumerable:!0,get:function(){return k.RequestType7}});Object.defineProperty(o,"RequestType8",{enumerable:!0,get:function(){return k.RequestType8}});Object.defineProperty(o,"RequestType9",{enumerable:!0,get:function(){return k.RequestType9}});Object.defineProperty(o,"ResponseError",{enumerable:!0,get:function(){return k.ResponseError}});Object.defineProperty(o,"ErrorCodes",{enumerable:!0,get:function(){return k.ErrorCodes}});Object.defineProperty(o,"NotificationType",{enumerable:!0,get:function(){return k.NotificationType}});Object.defineProperty(o,"NotificationType0",{enumerable:!0,get:function(){return k.NotificationType0}});Object.defineProperty(o,"NotificationType1",{enumerable:!0,get:function(){return k.NotificationType1}});Object.defineProperty(o,"NotificationType2",{enumerable:!0,get:function(){return k.NotificationType2}});Object.defineProperty(o,"NotificationType3",{enumerable:!0,get:function(){return k.NotificationType3}});Object.defineProperty(o,"NotificationType4",{enumerable:!0,get:function(){return k.NotificationType4}});Object.defineProperty(o,"NotificationType5",{enumerable:!0,get:function(){return k.NotificationType5}});Object.defineProperty(o,"NotificationType6",{enumerable:!0,get:function(){return k.NotificationType6}});Object.defineProperty(o,"NotificationType7",{enumerable:!0,get:function(){return k.NotificationType7}});Object.defineProperty(o,"NotificationType8",{enumerable:!0,get:function(){return k.NotificationType8}});Object.defineProperty(o,"NotificationType9",{enumerable:!0,get:function(){return k.NotificationType9}});Object.defineProperty(o,"ParameterStructures",{enumerable:!0,get:function(){return k.ParameterStructures}});var zr=Vt();Object.defineProperty(o,"LinkedMap",{enumerable:!0,get:function(){return zr.LinkedMap}});Object.defineProperty(o,"LRUCache",{enumerable:!0,get:function(){return zr.LRUCache}});Object.defineProperty(o,"Touch",{enumerable:!0,get:function(){return zr.Touch}});var Ns=en();Object.defineProperty(o,"Disposable",{enumerable:!0,get:function(){return Ns.Disposable}});var bn=we();Object.defineProperty(o,"Event",{enumerable:!0,get:function(){return bn.Event}});Object.defineProperty(o,"Emitter",{enumerable:!0,get:function(){return bn.Emitter}});var yn=Xe();Object.defineProperty(o,"CancellationTokenSource",{enumerable:!0,get:function(){return yn.CancellationTokenSource}});Object.defineProperty(o,"CancellationToken",{enumerable:!0,get:function(){return yn.CancellationToken}});var zn=rn();Object.defineProperty(o,"SharedArraySenderStrategy",{enumerable:!0,get:function(){return zn.SharedArraySenderStrategy}});Object.defineProperty(o,"SharedArrayReceiverStrategy",{enumerable:!0,get:function(){return zn.SharedArrayReceiverStrategy}});var wr=sn();Object.defineProperty(o,"MessageReader",{enumerable:!0,get:function(){return wr.MessageReader}});Object.defineProperty(o,"AbstractMessageReader",{enumerable:!0,get:function(){return wr.AbstractMessageReader}});Object.defineProperty(o,"ReadableStreamMessageReader",{enumerable:!0,get:function(){return wr.ReadableStreamMessageReader}});var vr=dn();Object.defineProperty(o,"MessageWriter",{enumerable:!0,get:function(){return vr.MessageWriter}});Object.defineProperty(o,"AbstractMessageWriter",{enumerable:!0,get:function(){return vr.AbstractMessageWriter}});Object.defineProperty(o,"WriteableStreamMessageWriter",{enumerable:!0,get:function(){return vr.WriteableStreamMessageWriter}});var Os=ln();Object.defineProperty(o,"AbstractMessageBuffer",{enumerable:!0,get:function(){return Os.AbstractMessageBuffer}});var I=gn();Object.defineProperty(o,"ConnectionStrategy",{enumerable:!0,get:function(){return I.ConnectionStrategy}});Object.defineProperty(o,"ConnectionOptions",{enumerable:!0,get:function(){return I.ConnectionOptions}});Object.defineProperty(o,"NullLogger",{enumerable:!0,get:function(){return I.NullLogger}});Object.defineProperty(o,"createMessageConnection",{enumerable:!0,get:function(){return I.createMessageConnection}});Object.defineProperty(o,"ProgressToken",{enumerable:!0,get:function(){return I.ProgressToken}});Object.defineProperty(o,"ProgressType",{enumerable:!0,get:function(){return I.ProgressType}});Object.defineProperty(o,"Trace",{enumerable:!0,get:function(){return I.Trace}});Object.defineProperty(o,"TraceValues",{enumerable:!0,get:function(){return I.TraceValues}});Object.defineProperty(o,"TraceFormat",{enumerable:!0,get:function(){return I.TraceFormat}});Object.defineProperty(o,"SetTraceNotification",{enumerable:!0,get:function(){return I.SetTraceNotification}});Object.defineProperty(o,"LogTraceNotification",{enumerable:!0,get:function(){return I.LogTraceNotification}});Object.defineProperty(o,"ConnectionErrors",{enumerable:!0,get:function(){return I.ConnectionErrors}});Object.defineProperty(o,"ConnectionError",{enumerable:!0,get:function(){return I.ConnectionError}});Object.defineProperty(o,"CancellationReceiverStrategy",{enumerable:!0,get:function(){return I.CancellationReceiverStrategy}});Object.defineProperty(o,"CancellationSenderStrategy",{enumerable:!0,get:function(){return I.CancellationSenderStrategy}});Object.defineProperty(o,"CancellationStrategy",{enumerable:!0,get:function(){return I.CancellationStrategy}});Object.defineProperty(o,"MessageStrategy",{enumerable:!0,get:function(){return I.MessageStrategy}});var Cs=ae();o.RAL=Cs.default});var kn=C(_r=>{"use strict";Object.defineProperty(_r,"__esModule",{value:!0});var wn=require("util"),ee=ct(),ut=class t extends ee.AbstractMessageBuffer{constructor(e="utf-8"){super(e)}emptyBuffer(){return t.emptyBuffer}fromString(e,r){return Buffer.from(e,r)}toString(e,r){return e instanceof Buffer?e.toString(r):new wn.TextDecoder(r).decode(e)}asNative(e,r){return r===void 0?e instanceof Buffer?e:Buffer.from(e):e instanceof Buffer?e.slice(0,r):Buffer.from(e,0,r)}allocNative(e){return Buffer.allocUnsafe(e)}};ut.emptyBuffer=Buffer.allocUnsafe(0);var kr=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),ee.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),ee.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),ee.Disposable.create(()=>this.stream.off("end",e))}onData(e){return this.stream.on("data",e),ee.Disposable.create(()=>this.stream.off("data",e))}},Pr=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),ee.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),ee.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),ee.Disposable.create(()=>this.stream.off("end",e))}write(e,r){return new Promise((n,i)=>{let c=p=>{p==null?n():i(p)};typeof e=="string"?this.stream.write(e,r,c):this.stream.write(e,c)})}end(){this.stream.end()}},vn=Object.freeze({messageBuffer:Object.freeze({create:t=>new ut(t)}),applicationJson:Object.freeze({encoder:Object.freeze({name:"application/json",encode:(t,e)=>{try{return Promise.resolve(Buffer.from(JSON.stringify(t,void 0,0),e.charset))}catch(r){return Promise.reject(r)}}}),decoder:Object.freeze({name:"application/json",decode:(t,e)=>{try{return t instanceof Buffer?Promise.resolve(JSON.parse(t.toString(e.charset))):Promise.resolve(JSON.parse(new wn.TextDecoder(e.charset).decode(t)))}catch(r){return Promise.reject(r)}}})}),stream:Object.freeze({asReadableStream:t=>new kr(t),asWritableStream:t=>new Pr(t)}),console,timer:Object.freeze({setTimeout(t,e,...r){let n=setTimeout(t,e,...r);return{dispose:()=>clearTimeout(n)}},setImmediate(t,...e){let r=setImmediate(t,...e);return{dispose:()=>clearImmediate(r)}},setInterval(t,e,...r){let n=setInterval(t,e,...r);return{dispose:()=>clearInterval(n)}}})});function Rr(){return vn}(function(t){function e(){ee.RAL.install(vn)}t.install=e})(Rr||(Rr={}));_r.default=Rr});var _n=C(h=>{"use strict";var Is=h&&h.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),As=h&&h.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Is(e,t,r)};Object.defineProperty(h,"__esModule",{value:!0});h.createMessageConnection=h.createServerSocketTransport=h.createClientSocketTransport=h.createServerPipeTransport=h.createClientPipeTransport=h.generateRandomPipeName=h.StreamMessageWriter=h.StreamMessageReader=h.SocketMessageWriter=h.SocketMessageReader=h.PortMessageWriter=h.PortMessageReader=h.IPCMessageWriter=h.IPCMessageReader=void 0;var _e=kn();_e.default.install();var Pn=require("path"),qs=require("os"),Ls=require("crypto"),ft=require("net"),U=ct();As(ct(),h);var Sr=class extends U.AbstractMessageReader{constructor(e){super(),this.process=e;let r=this.process;r.on("error",n=>this.fireError(n)),r.on("close",()=>this.fireClose())}listen(e){return this.process.on("message",e),U.Disposable.create(()=>this.process.off("message",e))}};h.IPCMessageReader=Sr;var Er=class extends U.AbstractMessageWriter{constructor(e){super(),this.process=e,this.errorCount=0;let r=this.process;r.on("error",n=>this.fireError(n)),r.on("close",()=>this.fireClose)}write(e){try{return typeof this.process.send=="function"&&this.process.send(e,void 0,void 0,r=>{r?(this.errorCount++,this.handleError(r,e)):this.errorCount=0}),Promise.resolve()}catch(r){return this.handleError(r,e),Promise.reject(r)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){}};h.IPCMessageWriter=Er;var Tr=class extends U.AbstractMessageReader{constructor(e){super(),this.onData=new U.Emitter,e.on("close",()=>this.fireClose),e.on("error",r=>this.fireError(r)),e.on("message",r=>{this.onData.fire(r)})}listen(e){return this.onData.event(e)}};h.PortMessageReader=Tr;var jr=class extends U.AbstractMessageWriter{constructor(e){super(),this.port=e,this.errorCount=0,e.on("close",()=>this.fireClose()),e.on("error",r=>this.fireError(r))}write(e){try{return this.port.postMessage(e),Promise.resolve()}catch(r){return this.handleError(r,e),Promise.reject(r)}}handleError(e,r){this.errorCount++,this.fireError(e,r,this.errorCount)}end(){}};h.PortMessageWriter=jr;var fe=class extends U.ReadableStreamMessageReader{constructor(e,r="utf-8"){super((0,_e.default)().stream.asReadableStream(e),r)}};h.SocketMessageReader=fe;var pe=class extends U.WriteableStreamMessageWriter{constructor(e,r){super((0,_e.default)().stream.asWritableStream(e),r),this.socket=e}dispose(){super.dispose(),this.socket.destroy()}};h.SocketMessageWriter=pe;var dt=class extends U.ReadableStreamMessageReader{constructor(e,r){super((0,_e.default)().stream.asReadableStream(e),r)}};h.StreamMessageReader=dt;var lt=class extends U.WriteableStreamMessageWriter{constructor(e,r){super((0,_e.default)().stream.asWritableStream(e),r)}};h.StreamMessageWriter=lt;var Rn=process.env.XDG_RUNTIME_DIR,Ds=new Map([["linux",107],["darwin",103]]);function $s(){let t=(0,Ls.randomBytes)(21).toString("hex");if(process.platform==="win32")return`\\\\.\\pipe\\vscode-jsonrpc-${t}-sock`;let e;Rn?e=Pn.join(Rn,`vscode-ipc-${t}.sock`):e=Pn.join(qs.tmpdir(),`vscode-${t}.sock`);let r=Ds.get(process.platform);return r!==void 0&&e.length>r&&(0,_e.default)().console.warn(`WARNING: IPC handle "${e}" is longer than ${r} characters.`),e}h.generateRandomPipeName=$s;function Ws(t,e="utf-8"){let r,n=new Promise((i,c)=>{r=i});return new Promise((i,c)=>{let p=(0,ft.createServer)(g=>{p.close(),r([new fe(g,e),new pe(g,e)])});p.on("error",c),p.listen(t,()=>{p.removeListener("error",c),i({onConnected:()=>n})})})}h.createClientPipeTransport=Ws;function Bs(t,e="utf-8"){let r=(0,ft.createConnection)(t);return[new fe(r,e),new pe(r,e)]}h.createServerPipeTransport=Bs;function Hs(t,e="utf-8"){let r,n=new Promise((i,c)=>{r=i});return new Promise((i,c)=>{let p=(0,ft.createServer)(g=>{p.close(),r([new fe(g,e),new pe(g,e)])});p.on("error",c),p.listen(t,"127.0.0.1",()=>{p.removeListener("error",c),i({onConnected:()=>n})})})}h.createClientSocketTransport=Hs;function Us(t,e="utf-8"){let r=(0,ft.createConnection)(t,"127.0.0.1");return[new fe(r,e),new pe(r,e)]}h.createServerSocketTransport=Us;function Fs(t){let e=t;return e.read!==void 0&&e.addListener!==void 0}function Vs(t){let e=t;return e.write!==void 0&&e.addListener!==void 0}function Js(t,e,r,n){r||(r=U.NullLogger);let i=Fs(t)?new dt(t):t,c=Vs(e)?new lt(e):e;return U.ConnectionStrategy.is(n)&&(n={connectionStrategy:n}),(0,U.createMessageConnection)(i,c,r,n)}h.createMessageConnection=Js});var En=C((hi,Sn)=>{"use strict";Sn.exports=_n()});var $n=require("util");var je=ps(En());var Tn=require("node:worker_threads");var N=class t extends Error{underlying;get name(){return this.underlying instanceof Error?this.underlying.name:typeof this.underlying=="string"||this.underlying instanceof String?`${this.underlying}`:JSON.stringify(this.underlying)}code;title;breadcrumbs;diagnostics;sessionId;constructor(e,r,n,i){e&&typeof e=="object"&&"message"in e&&typeof e.message=="string"?super(e.message):i?.message?super(i?.message):typeof e=="string"?super(e):super(),this.underlying=e,this.code=r,this.title=n,this.stack=e instanceof Error?e.stack:i?.stack,this.breadcrumbs=i?.breadcrumbs,this.diagnostics=i?.diagnostics,this.sessionId=i?.sessionId??Tn.workerData?.sessionId}serialize(){return{_isRayError:!0,code:this.code,title:this.title,name:this.name,message:this.message,stack:this.stack,breadcrumbs:this.breadcrumbs,diagnostics:this.diagnostics,sessionId:this.sessionId}}static tryDeserialize(e){if(!t.isRecord(e)||!t.hasProperty(e,"_isRayError")||!e._isRayError||Array.isArray(e)||!t.hasProperty(e,"code")||typeof e.code!="number"||!t.hasProperty(e,"title")||typeof e.title!="string"||!t.hasProperty(e,"name")||typeof e.name!="string")return null;let r=t.hasProperty(e,"message")&&typeof e.message=="string"?e.message:void 0,n=t.hasProperty(e,"stack")&&typeof e.stack=="string"?e.stack:void 0,i=t.hasProperty(e,"breadcrumbs")&&Array.isArray(e.breadcrumbs)?e.breadcrumbs:void 0,c=t.hasProperty(e,"diagnostics")&&typeof e.diagnostics=="object"?e.diagnostics:void 0,p=t.hasProperty(e,"sessionId")&&typeof e.sessionId=="string"?e.sessionId:void 0;return new t(e.name,e.code,e.title,{message:r,stack:n,breadcrumbs:i,diagnostics:c,sessionId:p})}static hasProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)&&typeof e[r]<"u"&&e[r]!==null}static isRecord(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}};function jn(t){return t.replace(/[^\\](\\ud800|\ud800|\0)/gi,"")}var We=require("node:perf_hooks");var Mn=require("worker_threads");var Qs=[];function pt(){return Qs}var xr=require("node:crypto"),Gs="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",Ks=128,me,Se;function Xs(t){!me||me.length<t?(me=Buffer.allocUnsafe(t*Ks),xr.webcrypto.getRandomValues(me),Se=0):Se+t>me.length&&(xr.webcrypto.getRandomValues(me),Se=0),Se+=t}function xn(t=21){Xs(t-=0);let e="";for(let r=Se-t;r<Se;r++)e+=Gs[me[r]&63];return e}var mt=class{options;terminationHandler;worker;resultHandlers;timeoutId;lastELU;isHandlingError=!1;loadPromiseRejection;get id(){return this.options.id}constructor(e,r){this.options=e,this.terminationHandler=r,this.resultHandlers=new Map,this.worker=new Mn.Worker(e.workerPath,{workerData:e,stdin:!0,stdout:!0,stderr:!0,resourceLimits:{maxOldGenerationSizeMb:e.maxHeapSizeMb}}),e.timeout&&(this.timeoutId=setTimeout(this.timeout.bind(this),e.timeout*1e3))}load(){this.worker.on("message",async r=>{let{kind:n}=r;switch(n){case"notify":{let{method:i}=r,{params:c}=r;switch(i){case"commandException":{this.isHandlingError=!0;let p=N.tryDeserialize(c)??new N(c,6,"Worker Error",{sessionId:this.id});p.diagnostics||(p.diagnostics=this.diagnostics()),await $e(p);break}case"captureException":{let p=N.tryDeserialize(c)??new N(c,6,"Worker Error",{sessionId:this.id});p.diagnostics||(p.diagnostics=this.diagnostics()),On(p);break}default:{te(i,c);break}}}break;case"request":{let{id:i}=r;try{let{method:c}=r,{params:p}=r,g=await Nn(c,{...p,sessionId:this.id,requestId:i});this.worker.postMessage({kind:"result",id:i,result:{success:!0,value:g}})}catch(c){this.worker.postMessage({kind:"result",id:i,result:{success:!1,error:c}})}}break;case"result":{let{id:i}=r,{result:c}=r;this.resultHandlers.get(i)?.(c),this.resultHandlers.delete(i)}break;default:break}}),this.worker.on("messageerror",async r=>{this.isHandlingError=!0;let n=new N(r,5,"Worker Message Error",{breadcrumbs:pt(),diagnostics:this.diagnostics(),sessionId:this.id});await $e(n)}),this.worker.on("error",async r=>{this.isHandlingError=!0;let n=new N(r,6,"Worker Error",{breadcrumbs:pt(),diagnostics:this.diagnostics(),sessionId:this.id});await $e(n)}),this.worker.on("exit",r=>{this.removeListeners(),this.terminationHandler?.(this.id),!this.isHandlingError&&te("commandExited",{sessionId:this.id,code:r})});let e=new Promise((r,n)=>{this.loadPromiseRejection=n});return Promise.race([this.request("initialize",{}),e]).finally(()=>{this.loadPromiseRejection=void 0})}async unload(){try{return await this.worker.terminate()}finally{this.removeListeners()}}request(e,r){return new Promise((n,i)=>{let c=xn(),p=g=>{if(g.success===!1){let P=N.tryDeserialize(g.error)??new N(g.error,8,"Worker Request Error");P.sessionId||(P.sessionId=this.id),P.diagnostics||(P.diagnostics=this.diagnostics()),i(P.serialize());return}n(g.value)};this.resultHandlers.set(c,p),this.worker.postMessage({kind:"request",id:c,method:e,params:r})})}diagnostics(){let e=this.worker.performance.eventLoopUtilization(),r=this.worker.performance.eventLoopUtilization(e,this.lastELU);return this.lastELU=e,{id:this.options.id,extensionName:this.options.extensionName,name:this.options.entryPointName,mode:this.options.entryPointMode,isDevelopment:this.options.isDevelopment,launchType:this.options.launchType,timeout:this.options.timeout,eventLoopUtilization:r,startedAt:this.options.startedAt}}async timeout(){try{this.worker.removeAllListeners("exit"),this.options.entryPointType==="tool"&&this.loadPromiseRejection?this.loadPromiseRejection(new Error(`The execution of ${this.options.entryPointName} timed out (${this.options.timeout}s max).`)):(this.options.isDevelopment&&await te("logCommand",{sessionId:this.id,level:"error",message:`The execution of ${this.options.entryPointName} timed out (${this.options.timeout}s max).`}),await this.worker.terminate())}catch(e){await $e(new N(e,14,"Worker Timeout Error",{breadcrumbs:pt(),diagnostics:this.diagnostics(),sessionId:this.id}))}finally{this.removeListeners(),this.terminationHandler?.(this.id)}}removeListeners(){this.worker.removeAllListeners("message"),this.worker.removeAllListeners("messageerror"),this.worker.removeAllListeners("error"),this.worker.removeAllListeners("exit"),this.timeoutId&&clearTimeout(this.timeoutId)}};var Te=new Map,Ee=new Set;async function ht(t){Ee.delete(t.id);let e=new mt(t,r=>{Te.delete(r),Ee.add(r),setTimeout(()=>{Ee.delete(t.id)},1e3)});return Te.set(t.id,e),e.load()}async function Cn(t){let e=Te.get(t);if(e)try{return await e.unload()}finally{Te.delete(t),Ee.add(t),setTimeout(()=>{Ee.delete(t)},1e3)}}async function In(t,e,r){if(Ee.has(t))throw new N(new Error("Worker already terminated"),17,"Race Condition Error",{breadcrumbs:[{level:"fatal",category:"Request",message:"Worker already terminated",timestamp:new Date(We.performance.timeOrigin+We.performance.now()).toISOString(),data:{method:e,sessionId:t}}],sessionId:t}).serialize();let n=Te.get(t);if(!n)throw new N(new Error("Could not communicate with worker"),11,"Unknown Command",{breadcrumbs:[{level:"fatal",category:"Request",message:"Could not communicate with worker",timestamp:new Date(We.performance.timeOrigin+We.performance.now()).toISOString(),data:{method:e,sessionId:t}}],sessionId:t}).serialize();return n.request(e,r)}function An(){return[...Te.values()].map(t=>t.diagnostics())}async function Nr(t){return{workerDiagnostics:An()}}async function Or(t){return{nodeVersion:process.version}}async function Cr(t){let e=t?.sessionId,r=t?.workerPath,n=t?.ownerOrAuthorName,i=t?.extensionName,c=t?.commandName,p=t?.commandMode,g=t?.commandPath,P=t?.assetsPath,R=t?.supportPath,A=t?.maxHeapSizeMb,$=t?.isDevelopment,F=t?.appearance,V=t?.textSize,re=t?.draftValues,J=t?.launchType,Q=t?.timeout,ne=t?.startedAt;if(!e||!r||typeof n>"u"||!i||!c||!p||!g||!P||!R||!A||!F||!V||!J)return Promise.reject(new Error(`Invalid parameters ${t}`));let B=t?.preferences,z=t?.arguments,K=t?.launchContext,E=t?.fallbackText,G=t?.canAccessAI,de=t?.canAccessBetterAIModels,Me=t?.isBrowserExtensionInstalled,He=t?.canAccessWindowManagement,Ue=t?.namedExport;return await ht({entryPointType:"command",id:e,workerPath:r,ownerOrAuthorName:n,extensionName:i,entryPointName:c,entryPointMode:p,commandPath:g,assetsPath:P,supportPath:R,preferences:B,maxHeapSizeMb:A,isDevelopment:$,appearance:F,textSize:V,draftValues:re,argumentValues:z,launchType:J,timeout:Q,startedAt:ne,launchContext:K,fallbackText:E,canAccessAI:G,canAccessBetterAIModels:de,isBrowserExtensionInstalled:Me,canAccessWindowManagement:He,namedExport:Ue})}async function Ir(t){let e=t?.sessionId,r=t?.workerPath,n=t?.ownerOrAuthorName,i=t?.extensionName,c=t?.toolName,p=t?.toolMode,g=t?.toolPath,P=t?.shouldExecuteFunctionsBeforeReturning,R=t?.assetsPath,A=t?.supportPath,$=t?.maxHeapSizeMb,F=t?.isDevelopment,V=t?.appearance,re=t?.textSize,J=t?.timeout,Q=t?.startedAt;if(!e||!r||typeof n>"u"||!i||!R||!A||!$||!V||!re)return Promise.reject(new Error(`Invalid parameters ${t}`));let ne=t?.preferences,B=t?.canAccessAI,z=t?.canAccessBetterAIModels,K=t?.isBrowserExtensionInstalled,E=t?.canAccessWindowManagement,G=t?.arguments,de=t?.namedExport;return await ht({entryPointType:"tool",id:e,workerPath:r,ownerOrAuthorName:n,extensionName:i,entryPointName:c,entryPointMode:p,toolPath:g,shouldExecuteFunctionsBeforeReturning:P,assetsPath:R,supportPath:A,preferences:ne,maxHeapSizeMb:$,isDevelopment:F,appearance:V,textSize:re,timeout:J,startedAt:Q,canAccessAI:B,canAccessBetterAIModels:z,isBrowserExtensionInstalled:K,canAccessWindowManagement:E,launchType:"userInitiated",arguments:G,namedExport:de})}async function Ar(t){let e=t?.sessionId;if(!e)throw new N("Native callback called without a session ID ",7,"Invalid Parameters").serialize();return await In(e,"nativeCallback",t)}async function qr(t){let e=t?.sessionId;return e?await Cn(e):Promise.reject(new Error("Invalid parameters"))}var qn=require("node:worker_threads"),Ln=require("node:path"),Z=je.createMessageConnection(new je.StreamMessageReader(process.stdin),new je.StreamMessageWriter(process.stdout));Z.onRequest("initialize",t=>xe(Or,t));Z.onRequest("loadCommand",t=>xe(Cr,t));Z.onRequest("loadTool",t=>xe(Ir,t));Z.onRequest("unloadEntryPoint",t=>xe(qr,t));Z.onRequest("nativeCallback",t=>xe(Ar,t));Z.onRequest("diagnostics",t=>xe(Nr,t));Z.onClose(()=>{process.exit(0)});Z.onError(t=>{let e=`Server connection error: ${t}`;process.stderr.write(`${e}
`),process.exit(1)});function Dn(){Z.listen()}function Nn(t,e){return Z.sendRequest(t,gt(e))}function te(t,e){return Z.sendNotification(t,gt(e))}async function $e(t){let e=await Lr(t);await te("commandException",e),te("commandExited",{sessionId:e.sessionId,code:e.code})}async function On(t){let e=await Lr(t);await te("captureException",e)}function gt(t){return Object.entries(t).reduce((e,[r,n])=>(e[r]=typeof n=="string"?jn(n):n,e),{})}var xe=async(t,e)=>{try{return await t(e)}catch(r){let n=N.tryDeserialize(r)??new N(r,8,"Worker Request Error");n.sessionId||(n.sessionId=e.sessionId);let i=gt(n.serialize());try{i=await Lr(n)}catch{}throw new Error(JSON.stringify(gt(i)))}},Lr=t=>new Promise((e,r)=>{if(typeof t.message>"u"||!t.stack)return e(t.serialize());let n=new qn.Worker((0,Ln.join)(__dirname,"..","source-mapper","index.js"),{workerData:{id:t.sessionId,message:t.message,stack:t.stack},stdin:!0,stdout:!0,stderr:!0,resourceLimits:{maxOldGenerationSizeMb:100}}),i=setTimeout(async()=>{n.removeAllListeners(),await n.terminate(),r(new Error("Source Map worker timed out after 10 seconds"))},10*1e3);n.on("message",c=>{clearTimeout(i),e({...t.serialize(),message:c.message,stack:c.stack})}),n.on("error",c=>{clearTimeout(i),r(c)}),n.on("messageerror",c=>{clearTimeout(i),r(c)}),n.on("exit",()=>{clearTimeout(i)})});function Wn(){console.log=Be("debug"),console.dir=console.log,console.debug=Be("debug"),console.info=Be("info"),console.warn=Be("warn"),console.error=Be("error")}function Be(t){return function(e,...r){try{let n=(0,$n.formatWithOptions)({showHidden:!1},e,...r);te("log",{level:t,message:n})}catch{process.stderr.write("Failed logging message: "+String(e)+", params: "+String(r))}}}process.title="Raycast Helper (Extensions)";process.on("uncaughtException",t=>{let e=`uncaughtException: ${t}`;process.stderr.write(`${e}
`),process.exit(1)});process.on("unhandledRejection",(t,e)=>{let r=`unhandledRejection: ${t}`;process.stderr.write(`${r}
`),process.exit(1)});Wn();Dn();
